{% extends "base.html" %}

{% block content %}
<h1 class="h3 mb-4">Financial Dashboard</h1>

<!-- Financial Summary Row -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h6 class="card-title text-success">Monthly Income</h6>
                <h4 class="text-success">${{ "%.2f"|format(monthly_income) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h6 class="card-title text-danger">Monthly Expenses</h6>
                <h4 class="text-danger">${{ "%.2f"|format(monthly_expenses.total) }}</h4>
                <small class="text-muted">
                    Bills: ${{ "%.0f"|format(monthly_expenses.bills) }} |
                    Loans: ${{ "%.0f"|format(monthly_expenses.loans) }}
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-{% if monthly_income - monthly_expenses.total > 0 %}success{% else %}warning{% endif %}">
            <div class="card-body text-center">
                <h6 class="card-title">Net Income</h6>
                <h4 class="{% if monthly_income - monthly_expenses.total > 0 %}text-success{% else %}text-warning{% endif %}">
                    ${{ "%.2f"|format(monthly_income - monthly_expenses.total) }}
                </h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-{% if debt_to_income_ratio < 36 %}success{% elif debt_to_income_ratio < 50 %}warning{% else %}danger{% endif %}">
            <div class="card-body text-center">
                <h6 class="card-title">Debt-to-Income</h6>
                <h4 class="{% if debt_to_income_ratio < 36 %}text-success{% elif debt_to_income_ratio < 50 %}text-warning{% else %}text-danger{% endif %}">
                    {{ "%.1f"|format(debt_to_income_ratio) }}%
                </h4>
                <small class="text-muted">
                    {% if debt_to_income_ratio < 36 %}Excellent{% elif debt_to_income_ratio < 50 %}Good{% else %}High{% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <a href="{{ url_for('overview') }}" class="btn btn-primary">
                        <i class="bi bi-calendar3 me-1"></i>View Overview
                    </a>
                    <a href="{{ url_for('income') }}" class="btn btn-success">
                        <i class="bi bi-cash-stack me-1"></i>Manage Income
                    </a>
                    <a href="{{ url_for('bills') }}" class="btn btn-info">
                        <i class="bi bi-receipt me-1"></i>Add Bill
                    </a>
                    <a href="{{ url_for('credit_cards') }}" class="btn btn-warning">
                        <i class="bi bi-credit-card me-1"></i>Manage Cards
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Next Income Payments -->
{% if next_income_dates %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Upcoming Income</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Days Away</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for income in next_income_dates %}
                            <tr>
                                <td>{{ income.source }}</td>
                                <td class="text-success">${{ "%.2f"|format(income.amount) }}</td>
                                <td>{{ income.date.strftime('%m/%d/%Y') }}</td>
                                <td>
                                    <!-- Calculate days away using income.days_away if available -->
                                    {% if income.days_away is defined %}
                                    {% set days_away = income.days_away %}
                                    {% else %}
                                    {% set days_away = 0 %}
                                    {% endif %}

                                    {% if days_away == 0 %}
                                    <span class="badge bg-success">Today</span>
                                    {% elif days_away == 1 %}
                                    <span class="badge bg-info">Tomorrow</span>
                                    {% elif days_away < 0 %}
                                    <span class="badge bg-warning">{{ (days_away * -1) }} days ago</span>
                                    {% else %}
                                    {{ days_away }} days
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Original Dashboard Content -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Urgent Bills (Due in 7 days)</h5>
            </div>
            <div class="card-body p-0">
                {% if urgent_bills %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Bill</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bill in urgent_bills %}
                            <tr>
                                <td>{{ bill.name }}</td>
                                <td>${{ "%.2f"|format(bill.amount) }}</td>
                                <td>{{ bill.due_date.strftime('%m/%d/%Y') }}</td>
                                <td>
                                    <a href="{{ url_for('mark_paid', bill_type='bill', item_id=bill.id) }}"
                                       class="btn btn-sm btn-success">
                                        <i class="bi bi-check-circle me-1"></i>Mark Paid
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <p class="mb-0">No urgent bills due soon.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Credit Card Summary</h5>
            </div>
            <div class="card-body p-0">
                {% if credit_cards %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Card</th>
                                <th>Balance</th>
                                <th>Limit</th>
                                <th>Utilization</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for card in credit_cards[:4] %}
                            <tr>
                                <td>{{ card.name }} (xxxx-{{ card.last_four }})</td>
                                <td>${{ "%.2f"|format(card.current_balance) }}</td>
                                <td>{% if card.limit %}${{ "%.2f"|format(card.limit) }}{% else %}&mdash;{% endif %}</td>
                                <td>
                                    {% if card.limit and card.limit > 0 %}
                                    {% set utilization = (card.current_balance / card.limit * 100) %}
                                    {% if utilization <= 10 %}
                                    <span class="badge bg-success">{{ "%.1f"|format(utilization) }}%</span>
                                    {% elif utilization <= 30 %}
                                    <span class="badge bg-info">{{ "%.1f"|format(utilization) }}%</span>
                                    {% elif utilization <= 50 %}
                                    <span class="badge bg-warning">{{ "%.1f"|format(utilization) }}%</span>
                                    {% else %}
                                    <span class="badge bg-danger">{{ "%.1f"|format(utilization) }}%</span>
                                    {% endif %}
                                    {% else %}
                                    &mdash;
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <p class="mb-0">No credit cards added yet.</p>
                    <a href="{{ url_for('credit_cards') }}" class="btn btn-outline-primary mt-2">Add Credit Card</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- All Upcoming Bills -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Upcoming Bills</h5>
                <a href="{{ url_for('bills') }}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body p-0">
                {% if bills %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Bill</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bill in bills[:10] %}
                            <tr>
                                <td>{{ bill.name }}</td>
                                <td>{{ bill.category or 'Uncategorized' }}</td>
                                <td>${{ "%.2f"|format(bill.amount) }}</td>
                                <td>{{ bill.due_date.strftime('%m/%d/%Y') }}</td>
                                <td>
                                    {% if bill.recurring %}
                                    <span class="badge bg-info">Recurring</span>
                                    {% endif %}
                                    {% if not bill.is_paid %}
                                    <span class="badge bg-warning">Unpaid</span>
                                    {% else %}
                                    <span class="badge bg-success">Paid</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <p class="mb-0">No upcoming bills.</p>
                    <a href="{{ url_for('bills') }}" class="btn btn-outline-primary mt-2">Add Bill</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}