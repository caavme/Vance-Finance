{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Financial Overview</h1>
    <div class="d-flex gap-2">
        <!-- Toggle for including/excluding items -->
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="includeExcluded"
                   {{ 'checked' if include_excluded else '' }}
                   onchange="toggleExcludedItems()">
            <label class="form-check-label" for="includeExcluded">
                Show Excluded Items
            </label>
        </div>

        <!-- Date Range Form -->
        <form method="GET" class="d-flex gap-2" id="dateRangeForm">
            <input type="date" name="start_date" value="{{ start_date }}" class="form-control form-control-sm">
            <input type="date" name="end_date" value="{{ end_date }}" class="form-control form-control-sm">
            <input type="hidden" name="include_excluded" value="{{ include_excluded|lower }}" id="includeExcludedInput">
            <button type="submit" class="btn btn-primary btn-sm">Update</button>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h5 class="card-title text-success">Total Income</h5>
                <h3 class="text-success">${{ "%.2f"|format(total_income) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <h5 class="card-title text-danger">Total Expenses</h5>
                <h3 class="text-danger">${{ "%.2f"|format(total_expenses) }}</h3>
                {% if excluded_expenses > 0 %}
                <small class="text-muted">
                    (+${{ "%.2f"|format(excluded_expenses) }} excluded)
                </small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center {{ 'border-success' if net_income >= 0 else 'border-warning' }}">
            <div class="card-body">
                <h5 class="card-title">Net Income</h5>
                <h3 class="{{ 'text-success' if net_income >= 0 else 'text-warning' }}">
                    ${{ "%.2f"|format(net_income) }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h5 class="card-title text-info">Savings Rate</h5>
                <h3 class="text-info">
                    {{ "%.1f"|format((net_income / total_income * 100) if total_income > 0 else 0) }}%
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Timeline -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Financial Timeline ({{ start_date.strftime('%m/%d/%Y') }} - {{ end_date.strftime('%m/%d/%Y') }})</h5>
        {% if excluded_expenses > 0 and not include_excluded %}
        <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            ${{ "%.2f"|format(excluded_expenses) }} in excluded expenses not shown
        </small>
        {% endif %}
    </div>
    <div class="card-body p-0">
        {% if timeline %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Running Balance</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in timeline %}
                    {% if include_excluded or not item.get('excluded', False) %}
                    <tr class="{{ 'table-secondary' if item.get('excluded', False) else '' }}">
                        <td>{{ item.date.strftime('%m/%d/%Y') }}</td>
                        <td>
                            {{ item.description }}
                            {% if item.get('excluded', False) %}
                            <span class="badge bg-secondary ms-2">Excluded</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if item.type == 'income' else 'danger' }}">
                                {{ item.category }}
                            </span>
                        </td>
                        <td>
                            <span class="text-{{ 'success' if item.amount > 0 else 'danger' }}">
                                ${{ "%.2f"|format(item.amount) }}
                            </span>
                        </td>
                        <td>
                            <span class="text-{{ 'success' if item.running_balance >= 0 else 'danger' }}">
                                ${{ "%.2f"|format(item.running_balance) }}
                            </span>
                        </td>
                        <td>
                            {% if item.get('excluded', False) %}
                            <i class="bi bi-eye-slash text-muted" title="Excluded from calculations"></i>
                            {% else %}
                            <i class="bi bi-check-circle text-success" title="Included in calculations"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4 text-muted">
            <p class="mb-0">No financial events found for the selected date range.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>function toggleExcludedItems() {
    const checkbox = document.getElementById('includeExcluded');
    const hiddenInput = document.getElementById('includeExcludedInput');
    hiddenInput.value = checkbox.checked ? 'true' : 'false';
    document.getElementById('dateRangeForm').submit();
}</script>

{% endblock %}